## HTTPS & SSL handshake

### HTTPS의 역할

1. 클라이언트-서버 간 주고 받는 정보들을 제3자가 못 보게 함
2. 서버가 제공하는 서비스를 신뢰할 수 있는지 검증

### SSL(Secure Socket Layer)

> 암호화 기반의 통신 프로토콜로 HTTP가 SSL 위에서 동작하면 HTTPS

**주요 특징**

- SSL 인증서를 통해 클라이언트와 서버 간 통신 보증
- 암호화된 데이터를 전달 (대칭키 + 공개키 암호화 사용)
- 클라이언트-서버 간 주고 받는 실제 정보는 **대칭키 방식**으로 암호화
- 대칭키 암호화에서 필요한 키는 **공개키 방식**으로 암호화

<br/>

> 컴퓨터와 컴퓨터가 네트워크를 통해 통신할 때 내부적으로 발생하는 3가지 단계: 악수(handshake) → 전송(세션) → 세션 종료

### SSL handshake 과정

1. 브라우저에 URL(https://~)을 입력하여 클라이언트가 서버에 요청 ➡️ Client Hello

- 이때 `클라이언트 측에서 생성한 랜덤 데이터`, `클라이언트가 지원하는 암호화 방식 리스트`, `세션 아이디` 정보 전달
- **클라이언트가 지원하는 암호화 방식 리스트**: 클라이언트-서버 간 어떤 암호화 방식을 사용할 것인지 결정하기 위해
- **세션 아이디**: 이미 SSL handshake를 한 경우 비용과 시간을 절약하기 위해 기존 세션을 재활용하게 되는데 이때 사용할 연결에 대한 식별자를 서버 측으로 전송

2. 서버가 Client Hello에 대해 응답 ➡️ Server Hello

- 이때 `서버 측에서 생성한 랜덤 데이터`, `서버가 선택한 클라이언트의 암호화 방식`, `인증서` 정보 전달
- **서버가 선택한 클라이언트의 암호화 방식**: 클라이언트가 전달한 암호화 방식 중 서버 측에서도 사용할 수 있는 암호화 방식 선택하여 전달 → 이후 클라이언트-서버는 해당 암호화 방식으로 정보 교환
- `인증서`: 서버의 공개키 포함 → 클라이언트는 인증서를 통해 서버의 공개키 획득
  _SSL 인증서: 클라이언트와 서버 간 통신을 제3자(CA)가 보증해주는 전자화된 문서_
  _SSL 인증서 내용: 서비스의 정보(인증서를 발급한 CA, 서비스의 도메인 등), 서버 측 공개키(공개키의 내용, 공개키의 암호화 방법) 포함_
  _CA(Certificate Authority): 인증서를 발급해주는 공인된 기관_

3. 클라이언트는 서버의 인증서가 공인된 CA에 의해 발급된 것인지 확인

   3-1. 클라이언트에 내장된 CA 리스트 확인 → 리스트에 해당 CA가 없다면 사용자에게 경고 메시지 출력

   3-2. 인증서가 해당 CA에 의해 발급된 것인지 확인하기 위해 클라이언트에 내장된 해당 CA의 공개키를 이용해 복호화 (복호화 성공 시 인증서는 해당 CA의 비밀키로 암호화된 문서임이 보증, 즉 해당 인증서는 믿을 수 있는 인증 기관에 의해서 발급되었음을 보증) → 인증서를 전송한 서버를 신뢰

   3-3. 클라이언트는 `서버의 랜덤 데이터` + `자신이 생성한 랜덤 데이터`를 조합하여 `pre master secret` 키(이후 대칭키를 만드는데 사용 → 제3자에게 절대로 노출X) 생성

   3-4. 인증서에 포함된 서버의 공개키로 pre master secret 값을 암호화하여 서버로 전달 → 서버의 비밀키로만 안전하게 복호화 가능 (공개키 암호화 방식)

4. 서버는 클라이언트가 전송한 암호화된 pre master secret 값을 자신의 비밀키로 복호화

   4-1. 서버와 클라이언트 모두 일련의 과정을 거쳐 pre master secret → master secret → session key 생성 (서버와 클라이언트 모두 대칭키인 session key를 공유)

5. 클라이언트와 서버는 handshake 단계의 종료를 서로에게 알림

**핵심 단계**

- 서버가 클라이언트에게 **SSL 인증서 전달**
- 클라이언트는 **해당 CA의 공개키로 인증서를 복호화하여 검증**
- 클라이언트는 pre master secret 생성 후 **인증서에 포함된 서버의 공개키로 암호화**하여 서버에 전달
- 서버는 **자신의 비밀키로 복호화**하여 pre master secret 값을 얻음
- 클라이언트와 서버는 공유된 pre master secret 값을 통해 **session key 생성**
- 이후 클라이언트-서버는 **세션키를 통해 암호화된 데이터 전송**

<br/>

### SSL 세션(데이터 전송) 과정

> 실제로 서버와 클라이언트가 데이터를 주고 받는 단계

- 상대방에게 데이터를 전송하기 전에 session key로 암호화하여 전달
- 암호화된 데이터를 전달받은 상대방은 같은 session key로 복호화
- 공개키 암호화 방식은 많은 컴퓨팅 파워를 사용하기 때문에, 효율적인 자원 사용을 위해 데이터 전송 시에는 대칭키 암호화 방식 사용

<br/>

### SSL 세션 종료

> 데이터 전송이 끝나면 SSL 통신이 끝났음을 서로에게 알림 → 통신에서 사용된 대칭키인 세션키를 폐기

<br/>

### 참고

[짧으니깐 영상 시청 추천](https://www.youtube.com/watch?v=8R0FUF_t_zk)

[HTTPS와 SSL 인증서](https://opentutorials.org/course/228/4894)

[HTTPS가 뭐고 왜 쓰나요?](https://www.youtube.com/watch?v=H6lpFRpyl14)
