> 이상 현상(Anomaly)
> <br/>잘못된 데이터베이스 설계로 인해 삽입·수정·삭제 연산 시 발생하는 부작용

<br/>

> 정규화(Normalization)
> <br/>데이터베이스 설계 방법 또는 데이터베이스 설계 후 결과물 검증 방법
> <br/>이상 현상을 제거하면서 데이터베이스를 올바르게 설계해나가는 과정

<br/>

### 과목별 성적 릴레이션 예시

| <ins>학번</ins> | 이름 | <ins>과목번호</ins> | 과목명           | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 | 평점 |
| --------------- | ---- | ------------------- | ---------------- | ------------------- | ------------------- | ---- | ---- |
| 1               | Mike | 123                 | Operating System | 2022                | 1                   | A0   | 4.0  |
| 1               | Mike | 456                 | Database         | 2022                | 2                   | A+   | 4.3  |
| 1               | Mike | 789                 | Network          | 2023                | 1                   | B0   | 3.0  |
| 2               | Amy  | 321                 | Algorithm        | 2021                | 2                   | C-   | 1.7  |
| 2               | Amy  | 123                 | Operating System | 2022                | 1                   | A+   | 4.3  |
| 3               | John | 321                 | Algorithm        | 2022                | 2                   | D+   | 1.3  |
| 3               | John | 321                 | Algorithm        | 2023                | 1                   | B+   | 3.3  |

<i>각 과목은 매년, 매학기에 수강할 수 있다고 가정</i>

- 각 학생이 수강한 과목별 성적 정보를 저장하고 있는 릴레이션
- 같은 학생이 같은 과목을 여러 번 수강 가능하므로 `학번`과 `과목번호`만으로 튜플을 유일하게 식별 불가 → `학번`, `과목번호`, `수강년도`, `수강학기` 속성으로 기본키 구성
- 동일한 데이터가 여러 번 중복으로 저장되어 저장 공간 낭비 + 데이터 삽입·수정·삭제 시 이상 현상 발생

<br/>

## 이상 현상(Anomaly)

### 삽입 이상(Insertion Anomaly)

> 새 데이터를 삽입하기 위해 불필요한 데이터도 함께 삽입해야 하는 문제

| <ins>학번</ins> | 이름            | <ins>과목번호</ins> | 과목명                    | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급            | 평점            |
| --------------- | --------------- | ------------------- | ------------------------- | ------------------- | ------------------- | --------------- | --------------- |
| 1               | Mike            | 123                 | Operating System          | 2022                | 1                   | A0              | 4.0             |
| 1               | Mike            | 456                 | Database                  | 2022                | 2                   | A+              | 4.3             |
| 1               | Mike            | 789                 | Network                   | 2023                | 1                   | B0              | 3.0             |
| 2               | Amy             | 321                 | Algorithm                 | 2021                | 2                   | C-              | 1.7             |
| 2               | Amy             | 123                 | Operating System          | 2022                | 1                   | A+              | 4.3             |
| 3               | John            | 321                 | Algorithm                 | 2022                | 2                   | D+              | 1.3             |
| 3               | John            | 321                 | Algorithm                 | 2023                | 1                   | B+              | 3.3             |
| <del>NULL</del> | <del>NULL</del> | <del>654</del>      | <del>Data Structure</del> | <del>NULL</del>     | <del>NULL</del>     | <del>NULL</del> | <del>NULL</del> |

- 새로운 과목이 추가되어 `(654, 'Data Structure')`의 데이터를 과목별 성적 릴레이션에 삽입하기 위해서는 해당 과목에 대한 수강 정보를 임의로 생성하여 삽입해야 함
- 과목별 성적 릴레이션의 기본키는 `학번`, `과목번호`, `수강년도`, `수강학기` 속성으로 구성되어 있기 때문에 해당 속성들은 NULL 값 불가 (by. 개체 무결성 제약조건) → 해당 과목을 수강한 학생이 없더라도, 과목 관련 데이터를 릴레이션에 삽입하기 위해서는 임의의 `학번`, `수강년도`, `수강학기` 속성값 필요

<br/>

### 갱신 이상(Update Anomaly)

> 중복 튜플 중 일부만 변경하여 데이터가 불일치하게 되는 모순의 문제

| <ins>학번</ins> | 이름 | <ins>과목번호</ins> | 과목명               | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 | 평점 |
| --------------- | ---- | ------------------- | -------------------- | ------------------- | ------------------- | ---- | ---- |
| 1               | Mike | 123                 | Operating System     | 2022                | 1                   | A0   | 4.0  |
| 1               | Mike | 456                 | Database             | 2022                | 2                   | A+   | 4.3  |
| 1               | Mike | 789                 | Network              | 2023                | 1                   | B0   | 3.0  |
| 2               | Amy  | 321                 | Compiler             | 2021                | 2                   | C-   | 1.7  |
| 2               | Amy  | 123                 | Operating System     | 2022                | 1                   | A+   | 4.3  |
| 3               | John | 321                 | Compiler             | 2022                | 2                   | D+   | 1.3  |
| 3               | John | <del>321</del>      | <del>Algorithm</del> | 2023                | 1                   | B+   | 3.3  |

- 과목별 성적 릴레이션에는 `과목번호`가 321인 튜플이 3개 존재 → `과목번호`, `과목명` 속성값에 대한 중복O
- 만약 `과목번호`가 321인 `과목명`을 Algorithm → Compiler로 변경 시, 튜플 3개의 `과목명` 속성값 모두 수정해야 함
- 만약 3개의 튜플 중 일부만 수정 시 `과목번호`가 321인 과목이 서로 다른 이름을 가지는 모순 발생

<br/>

### 삭제 이상(Deletion Anomaly)

> 튜플을 삭제하면 꼭 필요한 데이터까지 함께 삭제되는 데이터 손실의 문제

| <ins>학번</ins> | 이름 | <ins>과목번호</ins> | 과목명           | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 | 평점 |
| --------------- | ---- | ------------------- | ---------------- | ------------------- | ------------------- | ---- | ---- |
| 1               | Mike | 123                 | Operating System | 2022                | 1                   | A0   | 4.0  |
| 1               | Mike | 456                 | Database         | 2022                | 2                   | A+   | 4.3  |
| 1               | Mike | 789                 | Network          | 2023                | 1                   | B0   | 3.0  |
| 2               | Amy  | 321                 | Compiler         | 2021                | 2                   | C-   | 1.7  |
| 2               | Amy  | 123                 | Operating System | 2022                | 1                   | A+   | 4.3  |
| 3               | John | 321                 | Compiler         | 2022                | 2                   | D+   | 1.3  |
| 3               | John | 321                 | Algorithm        | 2023                | 1                   | B+   | 3.3  |

- 과목별 성적 릴레이션에서 학번으로 튜플 삭제 시 학생 관련 데이터만 삭제되는 것이 아닌 해당 학생이 수강한 과목 관련 데이터도 삭제
- `학번`이 1인 튜플은 수강한 과목인 Database, Network에 대한 정보를 유일하게 가지고 있음 → 해당 튜플 삭제 시 의도치 않게 과목 Database, Network에 대한 모든 데이터 삭제됨 (자퇴한 학생의 정보만을 삭제하고 싶었던 것이지, 과목을 없애고 싶었던 것이 아님 )

➡️ 관련 없는 데이터, 즉 관련 없는 속성들을 하나의 릴레이션에 모아두었기 때문에 이상 현상 발생 → 정규화 필요

<br/>

## 함수적 종속성(FD, Functional Dependency)

> 정규화 과정에서 고려해야 하는 속성들 간의 관련성으로, 하나의 릴레이션을 구성하는 속성들의 부분 집합을 X, Y라 할 때, 어느 시점에서든 릴레이션 내 모든 튜플에서 X값에 대한 Y값이 항상 하나면 "X가 Y를 함수적으로 결정한다" 또는 "Y가 X에 함수적으로 종속되어 있다"라고 함.

- 함수 종속 관계는 **X → Y**로 표현
- X는 **결정자**, Y는 **종속자**
- 릴레이션의 속성 자체가 가지고 있는 특성과 의미를 기반으로 판단
- 일반적으로 튜플을 유일하게 구별하는 후보키(기본키, 대체키)는 그 특성으로 릴레이션을 구성하는 다른 모든 속성들을 함수적으로 결정
- 릴레이션의 여러 튜플에서 결정자 속성 X값이 같으면 이와 연관된 종속자 속성 Y값도 모두 같아야 함
- 결정자와 종속자가 같거나, 결정자가 종속자를 포함하는 것처럼 당연한 함수적 종속 관계는 고려하지 않음

<br/>

### 학생 릴레이션의 함수적 종속성

| <ins>학번</ins> | 이름 | 입학년도 |
| --------------- | ---- | -------- |
| 1               | Mike | 2019     |
| 2               | Amy  | 2020     |
| 3               | John | 2022     |

- 학생 릴레이션에서 각 `학번` 속성값에 대응되는 `이름`, `입학년도` 속성값이 오직 하나
- 즉 `학번`이 정해지면 오직 하나의 `이름`과 `입학년도`가 결정됨 → `학번`이 `이름`과 `입학년도`를 결정 → 학생 릴레이션에서 `이름`, `입학년도` 속성은 `학번` 속성에 함수적으로 종속
- `학번` 속성은 결정자 / `이름`, `입학년도` 속성은 종속자
- 함수적 종속 관계 기호 표현

  ```
  학번 → 이름
  학번 → 입학년도
  학번 → (이름, 입학년도)
  ```

<br/>

### 과목별 성적 릴레이션의 함수적 종속성

| <ins>학번</ins> | 이름 | <ins>과목번호</ins> | 과목명           | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 | 평점 |
| --------------- | ---- | ------------------- | ---------------- | ------------------- | ------------------- | ---- | ---- |
| 1               | Mike | 123                 | Operating System | 2022                | 1                   | A0   | 4.0  |
| 1               | Mike | 456                 | Database         | 2022                | 2                   | A+   | 4.3  |
| 1               | Mike | 789                 | Network          | 2023                | 1                   | B0   | 3.0  |
| 2               | Amy  | 321                 | Algorithm        | 2021                | 2                   | C-   | 1.7  |
| 2               | Amy  | 123                 | Operating System | 2022                | 1                   | A+   | 4.3  |
| 3               | John | 321                 | Algorithm        | 2022                | 2                   | D+   | 1.3  |
| 3               | John | 321                 | Algorithm        | 2023                | 1                   | B+   | 3.3  |

- 함수적 종속 관계 기호 표현

  ```
  학번 → 이름
  과목번호 → 과목명
  (학번, 과목번호, 수강년도, 수강학기) → (등급, 평점)
  등급 → 평점
  ```

- **부분 함수 종속(PFD, Partial Functional Dependency)**: 속성 집합 Y가 속성 집합 X의 전체 뿐만 아니라 <ins>일부분에도</ins> 함수적으로 종속됨
- **완전 함수 종속(FFD, Full Functional Dependency)**: 속성 집합 Y가 속성 집합 X 전체에 함수적으로 종속되고 일부분에는 종속되지 않음
- 기본키 속성 집합 `(학번, 과목번호, 수강년도, 수강학기)`에 `이름`, `과목명` 속성은 부분 함수 종속 / `등급`, `평점` 속성은 완전 함수 종속

<br/>

## 정규화(Normalization)

> 함수적 종속성을 이용하여 릴레이션을 관련 있는 속성들로만 구성되도록 분해하여 이상 현상이 발생하지 않는 올바른 릴레이션으로 만들어가는 과정

- 일반적으로 릴레이션에 함수적 종속성이 **하나만 존재**하도록 정규화를 통해 릴레이션 분해
- 즉 관련 없는 함수적 종속성을 별개의 릴레이션으로 분리
- ⚠️릴레이션 분해 시 주의할 점: 분해된 릴레이션들을 자연 조인하여 분해 전의 릴레이션으로 다시 복원할 수 있어야 함
  - **무손실 분해(Nonloss Decomposition)**: 자연 조인을 하면 원래의 릴레이션으로 다시 복원할 수 있도록 정보의 손실 없이 릴레이션을 분해

<br/>

### 정규형(NF, Normal Form): 릴레이션이 정규화된 정도

<img src="https://github.com/jkde7721/cs-interview-study/assets/65665065/69b0db81-3e03-4b4e-ac6d-a0e9b826a9aa" width="37%"/>

- 릴레이션이 특정 정규형의 제약조건을 만족하면 릴레이션이 해당 정규형에 속한다고 표현
- 일반적으로 차수가 높은 정규형에 속하는 릴레이션일수록 데이터 중복이 줄어 이상 현상이 발생하지 않음
- **기본 정규형**: 제1,2,3정규형, 보이스/코드 정규형
- **고급 정규형**: 제4,5 정규형

<br/>

### 제1정규형(1NF, First Normal Form)

> 릴레이션에 속한 모든 속성의 도메인이 (더 이상 분해되지 않는) 원자값으로만 구성되어 있으면 제1정규형에 속함

- 관계 데이터베이스의 릴레이션은 모든 속성이 원자값을 가지는 특성 → 관계 데이터베이스의 릴레이션은 기본적으로 제1정규형 만족

<br/>

### 제2졍규형(2NF, Second Normal Form)

> 릴레이션이 제1정규형에 속하고, 기본키가 아닌 모든 속성이 기본키에 완전 함수 종속되면 제2정규형에 속함

**과목별 성적 릴레이션 스키마**
| <ins>학번</ins> | 이름 | <ins>과목번호</ins> | 과목명 | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 | 평점 |
| --------------- | ---- | ------------------- | ------ | ------------------- | ------------------- | ---- | ---- |

```
학번 → 이름
과목번호 → 과목명
(학번, 과목번호, 수강년도, 수강학기) → (등급, 평점)
등급 → 평점
```

- 기본키에 완전 함수 종속되지 못한 속성값이 릴레이션에 여러 번 중복되고, 관련 없는 속성이 하나의 릴레이션에 존재
- 즉 과목별 성적 릴레이션에서 이상 현상이 발생하는 이유는 릴레이션이 부분 함수 종속을 포함하고 있기 때문 → 기본키를 제외한 모든 속성(`이름`, `과목명`, `등급`, `평점`)이 기본키에 완전 함수 종속되도록 릴레이션 분해 → 제2정규형 만족

**릴레이션 분해 결과**

학생 릴레이션 스키마
| <ins>학번</ins> | 이름 |
| --------------- | ---- |

- 기본키인 `학번`에 `이름` 속성이 완전 함수 종속

과목 릴레이션 스키마
| <ins>과목번호</ins> | 과목명 |
| ------------------- | ------ |

- 기본키인 `과목번호`에 `과목명` 속성이 완전 함수 종속

성적 릴레이션 스키마
| <ins>학번</ins> | <ins>과목번호</ins> | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 | 평점 |
| --------------- | ------------------- | ------------------- | ------------------- | ---- | ---- |

- 기본키인 (`학번`, `과목번호`, `수강년도`, `수강학기`) 속성 집합에 `등급`, `평점` 속성이 완전 함수 종속
- but 여전히 `등급` → `평점` 함수 종속 관계 존재

<br/>

### 제3졍규형(3NF, Third Normal Form)

> 릴레이션이 제2정규형에 속하고, 기본키가 아닌 모든 속성이 기본키에 이행적 함수 종속되지 않으면 제3정규형에 속함

**성적 릴레이션 스키마**
| <ins>학번</ins> | <ins>과목번호</ins> | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 | 평점 |
| --------------- | ------------------- | ------------------- | ------------------- | ---- | ---- |

```
(학번, 과목번호, 수강년도, 수강학기) → (등급, 평점)
등급 → 평점
```

- 제2정규형에는 부분 함수 종속은 없지만 여전히 함수적 종속성을 여러 개 포함하고 있어 이상 현상 발생 가능
- 함수 종속 관계를 여러 개 포함하여 이행적 함수 종속 발생 → 릴레이션을 분해하여 이행적 함수 종속 제거 → 제3정규형 만족
- **이행적 함수 종속(Transitive FD)**: 릴레이션을 구성하는 3개의 속성 집합 X, Y, Z에 대해 함수 종속 관계 X → Y, Y → Z가 존재하면 논리적으로 X → Z가 성립, 이때 속성 집합 Z가 속성 집합 X에 이행적으로 함수 종속되었다고 함
- X → Y, Y → Z의 각 함수 종속 관계는 유지되도록 릴레이션을 분해 (X와 Y 속성 집합의 릴레이션 / Y와 Z 속성 집합의 릴레이션)
- 성적 릴레이션에서 (`학번`, `과목번호`, `수강년도`, `수강학기`) → `등급`, `등급` → `평점` 2개의 함수 종속 관계 존재
- `평점` 속성은 (`학번`, `과목번호`, `수강년도`, `수강학기`) 속성 집합에 이행적으로 함수 종속됨

**릴레이션 분해 결과**

성적 릴레이션 스키마
| <ins>학번</ins> | <ins>과목번호</ins> | <ins>수강년도</ins> | <ins>수강학기</ins> | 등급 |
| --------------- | ------------------- | ------------------- | ------------------- | ---- |

- 기본키인 (`학번`, `과목번호`, `수강년도`, `수강학기`) 속성 집합에 `등급` 속성이 완전 함수 종속

등급-평점 릴레이션 스키마
| <ins>등급</ins> | 평점 |
| ---- | -- |

- 기본키인 `등급` 속성에 `평점` 속성이 완전 함수 종속

<br/>

### 보이스/코드 정규형(BCNF, Boyce/Codd Normal Form) / 강한 제3정규형(Strong 3NF)

> 릴레이션이 제3정규형에 속하고, 릴레이션의 함수 종속 관계에서 모든 결정자가 후보키이면 보이스/코드 정규형에 속함

**강좌 신청 릴레이션**

| <ins>고객 아이디</ins> | <ins>인터넷 강좌</ins> | 담당 강사 번호 |
| ---------------------- | ---------------------- | -------------- |
| apple                  | 영어회화               | P001           |
| banana                 | 기초토익               | P002           |
| carrot                 | 영어회화               | P001           |
| carrot                 | 기초토익               | P004           |
| orange                 | 영어회화               | P003           |
| orange                 | 기초토익               | P004           |

_한 고객이 인터넷 강좌를 여러 개 신청할 수 있지만, 동일한 인터넷 강좌를 여러 번 신청 불가_

_강사 한 명이 인터넷 강좌를 하나만 담당할 수 있고, 하나의 인터넷 강좌는 여러 강사가 담당 가능_

```
(고객 아이디, 인터넷 강좌) → 담당 강사 번호
담당 강사 번호 → 인터넷 강좌
```

- 제3정규형에서 하나의 릴레이션에 여러 개의 후보키가 존재하는 경우 이상 현상 발생 가능
- 후보키가 아니면서 함수 종속 관계에서 다른 속성을 결정하기 때문에 이상 현상 발생 → 모든 결정자가 후보키가 되도록 릴레이션을 분해 → 보이스/코드 정규형 만족
- 강좌 신청 릴레이션의 후보키로 (`고객 아이디`, `인터넷 강좌`), (`고객 아이디`, `담당 강사 번호`) 존재
- 강좌 신청 릴레이션은 각 속성값이 원자값이므로 제1정규형 만족, 기본키가 아닌 `담당 강사 번호` 속성이 기본키에 완전 함수 종속되어 제2정규형 만족, 이행적 함수 종속되지 않아 제3정규형 만족(이행적 함수 종속되는 것처럼 보이는 `인터넷 강좌` 속성은 기본키 속성임)
- 이때 후보키가 아닌 `담당 강사 번호` 속성이 결정자가 되므로 이상 현상 발생 → `담당 강사 번호` 속성이 후보키가 되도록 릴레이션 분해

**릴레이션 분해 결과**

고객 담당 강사 릴레이션

| <ins>고객 아이디</ins> | <ins>담당 강사 번호</ins> |
| ---------------------- | ------------------------- |
| apple                  | P001                      |
| banana                 | P002                      |
| carrot                 | P001                      |
| carrot                 | P004                      |
| orange                 | P003                      |
| orange                 | P004                      |

- 함수 종속 관계 존재X

강좌 담당 릴레이션

| <ins>담당 강사 번호</ins> | 인터넷 강좌 |
| ------------------------- | ----------- |
| P001                      | 영어회화    |
| P002                      | 기초토익    |
| P003                      | 영어회화    |
| P004                      | 기초토익    |

- 유일한 후보키이자 기본키인 `담당 강사 번호` 속성에 `인터넷 강좌` 속성이 완전 함수 종속

❗두 릴레이션으로 분해되어 '한 고객이 동일한 인터넷 강좌를 여러 번 신청 불가`라는 제약 조건을 검사하기가 어려워짐 (제약 조건 검사를 위해 테이블 조인 필요)

<br/>

### 고급 정규형

**제4정규형**

> 릴레이션이 보이스/코드 정규형에 속하고, 다치 종속(MVD, Multi Valued Dependency)을 제거하면 제4정규형에 속함

**제5정규형**

> 릴레이션이 제4정규형에 속하고, 후보키를 통하지 않는 조인 종속(JD, Join Dependency)을 제거하면 제5정규형에 속함

<br/>

### 정리

<img src="https://github.com/jkde7721/cs-interview-study/assets/65665065/d8a11323-07e8-4ef8-ae47-523043da1927" width="27%"/>

➡️ 제3정규형이나 보이스/코드 정규형에 속하도록 릴레이션을 분해하여 정규화하는 것이 일반적

<br/>

### 참고

[데이터베이스 개론 3판](https://www.hanbit.co.kr/store/books/look.php?p_code=B6505632990)
