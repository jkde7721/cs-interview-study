## 교착상태 (Deadlock)

> 둘 이상의 프로세스들이 자원을 점유한 상태에서 서로 다른 프로세스가 점유하고 있는 자원을 요구하며 무한정 기다리는 현상

> 상호 배제에 의해 나타나는 문제점

<br/>

### 교착상태 4가지 필요조건

1.  **상호 배제(Mutual Exclusion)** : 한 번에 한 개의 프로세스만이 공유자원을 사용할 수 있음

2.  **점유와 대기(Hold and wait)** : 자원을 최소한 하나 보유하고, 다른 프로세스에 할당된 자원을 점유하기 위해 대기하는 프로세스가 존재해야 함

3.  **비선점(Non preemption)** : 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없음

4.  **환형 대기(Circular Wait)**

- 프로세스의 자원 점유 및 점유된 자원의 요구 관계가 원형을 이루면서 대기함

- 각 프로세스는 순환적으로 다음 프로세스가 요구하는 자원을 가지고 있음

- Hold and wait 관계의 프로세스들이 서로를 기다림

<br/>

### 교착상태 해결 방법

1.  **예방(Prevention)**

> 교착상태가 발생하지 않도록 사전에 시스템을 제어하는 방법

> 교착상태 발생의 4가지 조건 중에서 어느 하나를 제거함으로써 수행

- 상호 배제(Mutual Exclusion) 부정 : 한 번에 여러 프로세스가 공유 자원을 사용할 수 있도록 함

-> 추후 동기화 관련 문제가 발생할 수 있음

- 점유 및 대기(Hold and Wait) 부정 : 프로세스가 실행되기 전 필요한 모든 자원을 할당하여 프로세스 대기를 없애거나 자원이 점유되지 않은 상태에서만 자원을 요구하도록 함

- 비선점(Non preemption) 부정 : 모든 자원에 대한 선점을 허용, 자원을 점유하고 있는 프로세스가 다른 자원을 요구할 때 점유하고 있는 자원을 반납하고, 요구한 자원을 사용하기 위해 기다리게 함

- 환형 대기(Circular Wait) 부정 : 자원을 선형 순서로 분류하여 고유 번호를 할당하고, 각 프로세스는 현재 점유한 자원의 고유 번호보다 앞이나 뒤 어느 한쪽 방향으로만 자원을 요구하도록 함

단점 -> 자원 낭비가 가장 심한 기법, 시스템 처리량이나 자원 사용의 효율성을 떨어트리는 단점 발생

<br/>

2.  **회피(Avoidance)**

> 교착상태가 발생할 가능성이 있는 자원 할당(Unsafe allocation)을 하지 않고 안전한 상태(Safe state)에서만 자원 요청을 허용하는 방법

< 교착상태 회피를 하기 위해 다음과 같은 가정 필요 >

- 프로세스 수가 고정되어 있어야 함

- 자원의 종류와 수가 고정되어 있어야 함

- 프로세스가 요구하는 자원 및 최대 자원의 수를 알아야 함

- 프로세스는 자원을 사용 후 반드시 반납해야 함

**Safe state**

> safe sequence(교착상태를 발생시키지 않고 자원을 할당하는 순서)가 존재하며 모든 프로세스가 정상적으로 종료될 수 있는 상태를 의미

**Unsafe state**

> 교착상태가 발생할 가능성이 있는 상태

<br/>

**교착상태 회피 알고리즘**

① **은행원 알고리즘(Banker’s Algorithm)**

> 자원 할당 결정 전에 예상되는 모든 자원의 최대 할당량을 가지고 시뮬레이션을 하여 safe state에 들 수 있는지 여부를 검사하여 교착상태의 가능성을 미리 조사하는 알고리즘

- 다익스트라가 제안한 기법

- 은행에서 모든 고객의 요구를 충족할 수 있도록 현금을 대출해주는 것에서 유래

- 기본 개념 : CPU는 최소한 하나의 프로세스에게 할당해줄 만큼의 자원을 항상 보유하고 있어야 한다

-> 은행원 알고리즘을 적용하기 위해서는 자원의 양과 사용자(프로세스) 수가 일정해야 함

-> 은행원 알고리즘은 프로세스의 모든 요구를 유한한 시간 안에 할당하는 것을 보장
<br/>
**< 은행원 알고리즘 방법 >**

❶ 프로세스 시작 시 자신이 필요한 각 자원의 최대(Max) 개수를 미리 선언

❷ 각 프로세스에서 자원요청이 있을때 요청을 승인하면 시스템이 안전한 상태(safe state)로 유지되는 경우에만 자원을 할당

❸ 불안정 상태(unsafe state)가 예상되면 다른 프로세스가 끝날 때까지 대기

단점
-> 문제 발생에 대한 일관성과 가정이 완벽할 것이라는 것을 보장하기가 현실적으로 어렵다.

-> 시스템의 규모가 작은 운영체제라면 고려해볼 만한 방법이지만, 멀티 리소스, 멀티 프로세스의 복잡한 운영체제 환경에서는 자원 할당 그래프를 분석하면서 Safe state를 파악하기가 어렵다.

<br/>

② **자원 할당 그래프 알고리즘(Resource-Allocation Graph Algorithm)**

> 자원 할당 그래프에 예약 간선을 추가하여 예약 간선으로 설정한 자원에 대해서만 자원 할당을 요청할 수 있고 사이클이 형성되지 않을 때만 자원을 할당받는 방법

<br/>

**< 자원 할당 그래프 알고리즘 방법 >**

❶ 자원 할당 그래프에 예약 간선을 추가

- 예약 간선(claim edge) : 향후 요청할 수 있는 자원을 가리키는 점선으로 표시된 간선

❷ 프로세스 시작 전에 모든 예약 간선들을 자원 할당 그래프에 표시

❸ 프로세스는 예약 간선으로 설정한 자원에 대해서만 요청할 수 있고 주기가 형성되지 않을 때에만 자원을 할당 받음

<br/>

3.  **발견(Detection)**

> 교착상태 발견 알고리즘과 자원 할당 그래프 등을 사용하여 시스템에 교착상태가 발생했는지 점검하여 교착상태에 있는 프로세스와 자원을 발견하고 고침

단점 -> 지속적으로 교착상태를 확인하는 작업이 필요하기 때문에 오버헤드(성능 저하)가 발생

<br/>

4.  **회복(Recovery)**

> 교착상태를 일으킨 프로세스를 종료하거나 교착상태의 프로세스에 할당된 자원을 선점하여 프로세스나 자원을 회복하는 것

- 프로세스 종료 : 교착상태에 있는 프로세스를 종료하는 것

방법 1) 교착 상태의 프로세스를 모두 중지

방법 2) 교착 상태가 제거될 때까지 한 프로세스씩 중지
<br/>

- 자원 선점 : 교착상태의 프로세스가 점유하고 있는 자원을 선점하여 다른 프로세스에게 할당하며, 해당 프로세스를 일시 정지 시키는 방법

< 자원 섬점 시 고려해야 할 사항 >

1. 희생자 선택 (selection of a victim)

- 최소의 피해를 줄 수 있는 프로세스를 선택

2. 롤백(rollback)

- 선점 된 프로세스를 문제 없던 이전 상태로 롤백해야 함

- 보통 가장 안전한 방법은 프로세스를 중지시키고 재시작하는 것

3. 기아 상태(starvation)

- 한 프로세스가 계속 선점되어 기아 상태가 되는 것을 방지해야 함

- 한 가지 방법은 우선 순위를 사용하여 선점 될 때 마다 프로세스 우선순위를 높이는 것
